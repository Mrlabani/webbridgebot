<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebBridgeBot Media Player - {{.ChatID}}</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #222;
            color: #fff;
        }
        h1 {
            color: #00aaff;
            font-size: 2.5rem;
            font-weight: 700;
            margin: 20px 0;
            text-align: center;
        }
        #videoPlayer, #audioPlayer, #imageViewer {
            max-width: 90%;
            max-height: 60vh;
            display: none;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        .button-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin: 20px 0;
            gap: 15px;
        }
        .button {
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #0056b3;
        }
        #status {
            font-size: 1.5rem;
            margin: 15px 0;
            text-align: center;
            color: #aaa;
        }
    </style>
</head>
<body>
<h1>WebBridgeBot</h1>
<p id="status">Chat ID: {{.ChatID}}; Waiting for media...</p>
<video id="videoPlayer" controls></video>
<audio id="audioPlayer" controls></audio>
<img id="imageViewer" />
<div class="button-container">
    <button id="reloadButton" class="button">Reload</button>
    <button id="fullscreenButton" class="button">Fullscreen</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const videoPlayer = document.getElementById('videoPlayer');
        const audioPlayer = document.getElementById('audioPlayer');
        const imageViewer = document.getElementById('imageViewer');
        const fullscreenButton = document.getElementById('fullscreenButton');
        const reloadButton = document.getElementById('reloadButton');
        const statusText = document.getElementById('status');
        let ws;
        let latestMedia = { url: null, mimeType: null };
        let attemptReconnect = true;

        const setupWebSocket = () => {
            const wsAddress = 'ws://' + window.location.host + '/ws/{{.ChatID}}';
            ws = new WebSocket(wsAddress);

            ws.addEventListener('message', (event) => handleWebSocketMessage(event));
            ws.addEventListener('error', (error) => handleWebSocketError(error));
            ws.addEventListener('open', () => handleWebSocketOpen());
            ws.addEventListener('close', () => handleWebSocketClose());
        };

        const handleWebSocketOpen = () => {
            console.log('WebSocket connection opened.');
        };

        const handleWebSocketMessage = (event) => {
            const data = JSON.parse(event.data);
            console.log('Message from server: ', data);
            latestMedia = { url: data.url, mimeType: data.mimeType };
            playMedia(data.url, data.mimeType);
        };

        const handleWebSocketClose = () => {
            console.log('WebSocket closed. Attempting to reconnect...');
            if (attemptReconnect) setTimeout(setupWebSocket, 3000);
        };

        const handleWebSocketError = (error) => {
            console.error('WebSocket encountered an error: ', error.message);
            ws.close(); // Ensure the WebSocket is closed properly before attempting to reconnect
        };

        const playMedia = (url, mimeType) => {
            if (mimeType.startsWith('video')) {
                updateUIForMedia(videoPlayer, [audioPlayer, imageViewer], mimeType);
                loadAndPlayMedia(videoPlayer, url);
            } else if (mimeType.startsWith('audio')) {
                updateUIForMedia(audioPlayer, [videoPlayer, imageViewer], mimeType);
                loadAndPlayMedia(audioPlayer, url);
            } else if (mimeType.startsWith('image')) {
                updateUIForMedia(imageViewer, [videoPlayer, audioPlayer], mimeType);
                loadImage(imageViewer, url);
            } else {
                console.log('Unsupported media type: ', mimeType);
            }
        };

        const updateUIForMedia = (playerToShow, playersToHide, mimeType) => {
            playersToHide.forEach(player => {
                if (player.pause) player.pause();
                player.style.display = 'none';
            });
            playerToShow.style.display = 'block';

            // Adjust status text based on media type
            if (mimeType.startsWith('video')) {
                statusText.textContent = 'Playing Video...';
                fullscreenButton.style.display = 'inline-block';
                reloadButton.style.display = 'inline-block';
                fullscreenButton.onclick = () => enterFullScreen(playerToShow);
                reloadButton.onclick = () => playMedia(latestMedia.url, latestMedia.mimeType);
            } else if (mimeType.startsWith('audio')) {
                statusText.textContent = 'Playing Audio...';
                fullscreenButton.style.display = 'none';
                reloadButton.style.display = 'none';
            } else if (mimeType.startsWith('image')) {
                statusText.textContent = 'Viewing Image... Click to view full screen.';
                fullscreenButton.style.display = 'none';
                reloadButton.style.display = 'none';
            } else {
                statusText.textContent = 'Unsupported media type.';
                fullscreenButton.style.display = 'none';
                reloadButton.style.display = 'none';
            }
        };

        const loadAndPlayMedia = (player, url) => {
            const uniqueUrl = url + '?nocache=' + new Date().getTime();
            player.src = uniqueUrl;
            player.load();
            player.play().catch(error => {
                console.error('Error playing media: ', error);
                //statusText.textContent = 'Error playing media. Retrying...';
                //setTimeout(() => playMedia(url, latestMedia.mimeType), 3000);
            });
        };

        const loadImage = (imageElement, url) => {
            const uniqueUrl = url + '?nocache=' + new Date().getTime();
            imageElement.src = uniqueUrl;
        };

        const enterFullScreen = (element) => {
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.webkitRequestFullscreen) { /* Safari */
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) { /* IE11 */
                element.msRequestFullscreen();
            } else if (element.mozRequestFullScreen) { /* Firefox */
                element.mozRequestFullScreen();
            }
        };

        imageViewer.addEventListener('click', () => {
            enterFullScreen(imageViewer);
        });

        setupWebSocket();
    });

</script>
</body>
</html>
